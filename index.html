<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Happiness Meter</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; margin: 0; padding: 20px; min-height: 100vh; }
        .container { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 450px; margin: auto; border: 1px solid rgba(255,255,255,0.1); }
        #video { border-radius: 15px; width: 100%; height: auto; display: none; margin-bottom: 15px; transform: scaleX(-1); }
        #score-display { font-size: 4rem; font-weight: 800; margin: 10px 0; transition: 0.3s; }
        #hindi-quote { font-size: 1.1rem; min-height: 50px; color: #ffcc00; margin: 15px 0; line-height: 1.4; }
        .controls { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        button { border: none; padding: 15px 30px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; transition: 0.3s; font-weight: bold; width: 80%; }
        .btn-start { background: #00b09b; color: white; box-shadow: 0 4px 15px rgba(0, 176, 155, 0.4); }
        .btn-stop { background: #ff5f6d; color: white; display: none; box-shadow: 0 4px 15px rgba(255, 95, 109, 0.4); }
        .btn-beauty { background: #8e44ad; color: white; margin-top: 10px; }
        #result-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #333; padding: 30px; border-radius: 25px; box-shadow: 0 0 100px rgba(0,0,0,0.8); z-index: 1000; width: 85%; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="greeting">Loading...</h2>
        <div id="score-display">0%</div>
        <div id="hindi-quote">‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è 'Start Meter' ‡§¶‡§¨‡§æ‡§è‡§Ç</div>
        
        <video id="video" autoplay muted playsinline></video>
        
        <div class="controls">
            <button id="startBtn" class="btn-start" onclick="startApp()">Start Meter</button>
            <button id="stopBtn" class="btn-stop" onclick="stopApp()">Stop & Get Result</button>
            <button class="btn-beauty" onclick="showBeauty()">‚ú® Beauty Index</button>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="result-popup">
        <h2 style="color: #8e44ad; margin-top: 0;">‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! (Great!)</h2>
        <p id="final-msg" style="font-size: 1.3rem; margin-bottom: 25px;"></p>
        <button onclick="closePopup()" style="background: #333; color: white; width: 100%;">Close</button>
    </div>

    <script>
        let isRunning = false;
        let maxScore = 0;
        const video = document.getElementById('video');
        const scoreDiv = document.getElementById('score-display');
        const quoteDiv = document.getElementById('hindi-quote');
        const greetingDiv = document.getElementById('greeting');

        // 1. Time-based Greeting
        const hour = new Date().getHours();
        if (hour < 12) greetingDiv.innerText = "Good Morning! ‚òÄÔ∏è";
        else if (hour < 17) greetingDiv.innerText = "Good Afternoon! ‚òï";
        else greetingDiv.innerText = "Good Evening! üåô";

        async function startApp() {
            try {
                document.getElementById('startBtn').innerText = "Loading AI Brain...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');

                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                
                video.style.display = 'block';
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                
                isRunning = true;
                runDetection();
            } catch (err) {
                alert("Please allow camera access to use the meter!");
                console.error(err);
            }
        }

        async function runDetection() {
            if (!isRunning) return;
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            if (detections.length > 0) {
                const happyScore = detections[0].expressions.happy;
                const percent = Math.round(happyScore * 100);
                if(percent > maxScore) maxScore = percent;
                
                scoreDiv.innerText = percent + "%";
                updateUI(percent);
            }
            setTimeout(runDetection, 300);
        }

        function updateUI(p) {
            if (p < 25) {
                quoteDiv.innerText = "‡§Æ‡•Å‡§∏‡•ç‡§ï‡•Å‡§∞‡§æ‡§á‡§è, ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡•Å‡§∏‡•ç‡§ï‡§æ‡§® ‡§Ö‡§®‡§Æ‡•ã‡§≤ ‡§π‡•à! üòä";
                scoreDiv.style.color = "#ff6b6b";
            } else if (p < 55) {
                quoteDiv.innerText = "‡§µ‡§æ‡§π! ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡•Å‡§∏‡•ç‡§ï‡§æ‡§® ‡§ß‡•Ä‡§∞‡•á-‡§ß‡•Ä‡§∞‡•á ‡§¨‡§¢‡§º ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ Good!";
                scoreDiv.style.color = "#ffd93d";
            } else if (p < 85) {
                quoteDiv.innerText = "‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ‡§ñ‡•Å‡§∂ ‡§≤‡§ó ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‚ú®";
                scoreDiv.style.color = "#6bc119";
            } else {
                quoteDiv.innerText = "‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! ‡§Ü‡§™‡§ï‡•Ä ‡§ñ‡•Å‡§∂‡•Ä ‡§∏‡§¨‡§∏‡•á ‡§™‡•ç‡§Ø‡§æ‡§∞‡•Ä ‡§π‡•à‡•§ üòç";
                scoreDiv.style.color = "#4ef3e1";
            }
        }

        function stopApp() {
            isRunning = false;
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop()); // Turn off camera
            
            video.style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').innerText = "Restart Meter";
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('result-popup').style.display = 'block';
            document.getElementById('final-msg').innerText = `‡§Ü‡§ú ‡§ï‡§æ ‡§â‡§ö‡•ç‡§ö‡§§‡§Æ Happiness Score: ${maxScore}%\n‡§∏‡§¶‡§æ ‡§Æ‡•Å‡§∏‡•ç‡§ï‡•Å‡§∞‡§æ‡§§‡•á ‡§∞‡§π‡§ø‡§Ø‡•á!`;
        }

        function showBeauty() {
            alert("Beauty Index: 100% ‚ú®\nAI Analysis: ‡§Ü‡§™ ‡§Ü‡§ú ‡§¨‡§π‡•Å‡§§ ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§∂‡§æ‡§≤‡•Ä ‡§≤‡§ó ‡§∞‡§π‡•á ‡§π‡•à‡§Ç!");
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('result-popup').style.display = 'none';
            maxScore = 0;
            scoreDiv.innerText = "0%";
            scoreDiv.style.color = "white";
            quoteDiv.innerText = "Ready for another session?";
        }
    </script>
</body>
</html>
